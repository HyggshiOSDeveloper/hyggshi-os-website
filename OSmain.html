<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyggshi OS Web Edition</title>
  <style>
    /* --- Reset & Base --- */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #e6e6e6;
      user-select: none;
      background: #000;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* --- Desktop --- */
    .desktop {
      position: relative;
      height: 100%;
      width: 100%;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(80,120,255,0.18), rgba(0,0,0,0) 60%),
        radial-gradient(1000px 700px at 80% 100%, rgba(255,120,200,0.12), rgba(0,0,0,0) 60%),
        url('Resources/background.png') center/cover no-repeat fixed;
      overflow: hidden;
    }

    /* --- Desktop icons --- */
    .desktop-icons {
      position: absolute;
      top: 12px;
      left: 12px;
      display: grid;
      grid-template-columns: repeat(1, 88px);
      gap: 12px 16px;
      padding-bottom: 64px;
    }
    .icon {
      width: 88px;
      padding: 10px 8px;
      text-align: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 8px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.12);
      backdrop-filter: blur(6px) saturate(120%);
      transition: transform 140ms ease, background 140ms ease, box-shadow 140ms ease;
      cursor: default;
    }
    .icon:hover { background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06)); box-shadow: 0 8px 18px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.18); }
    .icon:active { transform: scale(0.98); }
    .icon img {
      display: block;
      width: 36px;
      height: 36px;
      margin: 0 auto 8px;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.4));
    }
    .icon .label {
      font-size: 12px;
      line-height: 1.2;
      color: #f2f2f2;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      white-space: normal;
    }

    /* --- Windows --- */
    .window {
      position: absolute;
      min-width: 360px;
      min-height: 260px;
      max-width: calc(100% - 24px);
      max-height: calc(100% - 88px);
      background: linear-gradient(180deg, rgba(30,30,36,0.88), rgba(18,18,24,0.82));
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.08) inset;
      backdrop-filter: blur(10px) saturate(120%);
    }
    .window.hidden { display: none; }
    .window.minimized { display: none; }
    .window.active { outline: 2px solid rgba(112, 160, 255, 0.55); box-shadow: 0 24px 60px rgba(0,0,0,0.65), 0 0 0 1px rgba(112,160,255,0.25) inset; }

    .titlebar {
      height: 38px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.06));
      cursor: move;
      gap: 8px;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.35);
    }
    .titlebar .traffic {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.45);
      display: inline-block;
      cursor: pointer;
    }
    .btn:hover { filter: brightness(1.05); box-shadow: 0 0 0 2px rgba(255,255,255,0.15) inset; }
    .btn-close { background: #ff5f57; }
    .btn-min   { background: #febc2e; }
    .btn-max   { background: #28c840; }
    .titlebar .title {
      margin-left: 8px;
      font-weight: 600;
      color: #fff;
      text-shadow: 0 1px 1px rgba(0,0,0,0.5);
    }
    .titlebar .spacer { flex: 1; }

    .content {
      height: calc(100% - 38px);
      background: linear-gradient(180deg, rgba(12,12,16,0.55), rgba(12,12,16,0.35));
      padding: 10px;
      overflow: auto;
      user-select: text;
    }

    /* Notes app */
    .notes-toolbar { display: flex; gap: 8px; margin-bottom: 8px; }
    .notes-toolbar input[type="text"] {
      flex: 1;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
    }
    .notes-toolbar button {
      background: #2b76ff;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .notes-textarea {
      width: 100%;
      height: calc(100% - 48px);
      resize: none;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.16);
      color: #f8f8f8;
      padding: 10px;
      border-radius: 8px;
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    /* Browser app */
    .browser-bar { display: flex; gap: 8px; margin-bottom: 8px; }
    .browser-bar input[type="text"] {
      flex: 1;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
    }
    .browser-bar button {
      background: #2b76ff;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .browser-frame {
      width: 100%;
      height: calc(100% - 48px);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 10px;
      background: radial-gradient(600px 400px at 50% 0%, rgba(80,120,255,0.05), transparent), #0e0e12;
    }

    /* --- Taskbar --- */
    .taskbar {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 48px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      background: linear-gradient(180deg, rgba(18,18,24,0.55), rgba(12,12,16,0.55));
      border-top: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px) saturate(140%);
      box-shadow: 0 -8px 20px rgba(0,0,0,0.45);
    }
    .taskbar .apps { display: flex; gap: 6px; align-items: center; flex: 1; }
    .task-btn {
      min-width: 120px;
      padding: 8px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 8px;
      color: #f2f2f2;
      cursor: pointer;
      text-align: left;
      transition: background 140ms ease, box-shadow 140ms ease;
    }
    .task-btn:hover { background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); box-shadow: 0 6px 12px rgba(0,0,0,0.35); }
    .task-btn.active { outline: 2px solid rgba(112,160,255,0.6); box-shadow: 0 0 0 1px rgba(112,160,255,0.35) inset; }
    .clock { width: 120px; text-align: right; color: #fff; font-weight: 600; }
    
    /* --- Start button & menu --- */
    .start-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      height: 32px;
      padding: 0 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: background 140ms ease, transform 80ms ease;
    }
    .start-btn:hover { background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08)); }
    .start-btn:active { transform: translateY(1px); }
    .start-menu {
      position: absolute;
      left: 8px;
      bottom: 56px;
      width: 280px;
      background: linear-gradient(180deg, rgba(18,18,24,0.95), rgba(12,12,16,0.92));
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 12px;
      box-shadow: 0 16px 36px rgba(0,0,0,0.6);
      padding: 8px;
      display: none;
      backdrop-filter: blur(8px);
    }
    .start-menu.show { display: block; }
    .start-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; color: #f0f0f0; transition: background 140ms ease; }
    .start-item:hover { background: rgba(255,255,255,0.10); }
    
    /* --- Context menu --- */
    .context-menu { position: absolute; min-width: 200px; background: linear-gradient(180deg, rgba(20,20,26,0.98), rgba(16,16,22,0.96)); border: 1px solid rgba(255,255,255,0.16); border-radius: 10px; padding: 6px; display: none; z-index: 20000; backdrop-filter: blur(10px) saturate(130%); box-shadow: 0 12px 28px rgba(0,0,0,0.55); }
    .context-menu.show { display: block; }
    .ctx-item { padding: 8px 10px; border-radius: 6px; cursor: pointer; color: #eee; transition: background 140ms ease; }
    .ctx-item:hover { background: rgba(255,255,255,0.12); }
    
    /* --- Resize handles --- */
    .resize { position: absolute; }
    .resize.n { top: -3px; left: 0; right: 0; height: 6px; cursor: n-resize; }
    .resize.s { bottom: -3px; left: 0; right: 0; height: 6px; cursor: s-resize; }
    .resize.e { right: -3px; top: 0; bottom: 0; width: 6px; cursor: e-resize; }
    .resize.w { left: -3px; top: 0; bottom: 0; width: 6px; cursor: w-resize; }
    .resize.ne { right: -3px; top: -3px; width: 10px; height: 10px; cursor: ne-resize; }
    .resize.nw { left: -3px; top: -3px; width: 10px; height: 10px; cursor: nw-resize; }
    .resize.se { right: -3px; bottom: -3px; width: 10px; height: 10px; cursor: se-resize; }
    .resize.sw { left: -3px; bottom: -3px; width: 10px; height: 10px; cursor: sw-resize; }

    /* --- File Manager --- */
    .fm-toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .fm-toolbar button {
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 140ms ease, box-shadow 140ms ease;
    }
    .fm-toolbar button:hover { background: linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08)); box-shadow: 0 6px 12px rgba(0,0,0,0.35); }
    .fm-breadcrumb { margin-left: auto; color: #ddd; font-size: 13px; }
    .fm-breadcrumb span { cursor: pointer; color: #9ec5ff; }
    .fm-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      user-select: none;
    }
    .fm-item {
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      cursor: default;
      text-align: center;
      transition: transform 120ms ease, background 140ms ease, box-shadow 140ms ease;
    }
    .fm-item:hover { background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); box-shadow: 0 8px 16px rgba(0,0,0,0.35); transform: translateY(-1px); }
    .fm-item.selected { outline: 2px solid #70a0ff; box-shadow: 0 0 0 1px rgba(112,160,255,0.35) inset; }
    .fm-item img { width: 36px; height: 36px; display: block; margin: 4px auto 8px; }
    .fm-name { font-size: 12px; color: #f2f2f2; word-break: break-word; }

    /* --- Activation watermark --- */
    .watermark {
      position: absolute;
      right: 16px;
      bottom: 64px;
      color: rgba(255,255,255,0.6);
      text-align: right;
      font-size: 14px;
      line-height: 1.5;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    .watermark.hidden { display: none; }
    
    /* --- Power overlay --- */
    .power-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 50000;
    }
    .power-overlay.show { display: flex; }
    .power-overlay .msg { opacity: 0.9; font-size: 18px; margin-top: 8px; }

    /* --- Calculator Window specific styles --- */
    #win-calculator .calc-op {
      background: #1e2c4a;
      color: #9ec5ff;
      font-weight: bold;
    }
    #win-calculator .calc-func {
      background: #2b2b2b;
      color: #ffb4b4;
      font-weight: bold;
    }
    #win-calculator button {
      font-size: 1.2em;
      padding: 14px 0;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      transition: background 0.15s;
    }
    #win-calculator button:hover {
      background: rgba(80,120,255,0.18);
    }
    #win-calculator button:active {
      background: rgba(80,120,255,0.28);
    }

    .window.dragging {
      opacity: 0.97;
      box-shadow: 0 24px 60px rgba(80,120,255,0.25), 0 0 0 2px #70a0ff inset;
      transition: none;
    }
  </style>
 </head>
 <body>
  <div class="desktop" id="desktop">
    <div class="desktop-icons">
      <div class="icon" data-launch="notes">
        <img alt="Notes" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M19 3H5c-1.1 0-2 .9-2 2v14l4-4h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z'/%3E%3C/svg%3E"/>
        <div class="label">Ghi chú</div>
      </div>
      <div class="icon" data-launch="browser">
        <img alt="Browser" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2C6.477 2 2 6.477 2 12c0 5.522 4.477 10 10 10s10-4.478 10-10C22 6.477 17.523 2 12 2zm6.93 6H15.9a15.22 15.22 0 0 0-1.308-3.244A8.025 8.025 0 0 1 18.93 8zM12 4.06c.72.96 1.34 2.215 1.78 3.94H10.22C10.66 6.275 11.28 5.02 12 4.06zM4.07 8A8.025 8.025 0 0 1 9.408 4.756 15.22 15.22 0 0 0 8.1 8H4.07zM4.06 12c0-.68.05-1.34.146-1.98H8.06c-.04.645-.06 1.31-.06 1.98 0 .67.02 1.335.06 1.98H4.206A8.96 8.96 0 0 1 4.06 12zM5.07 16h3.03c.28 1.134.64 2.14 1.004 2.88A8.015 8.015 0 0 1 5.07 16zM10.22 16h3.56c-.44 1.725-1.06 2.98-1.78 3.94-.72-.96-1.34-2.215-1.78-3.94zM14.896 18.88c.364-.74.725-1.746 1.004-2.88h3.03a8.015 8.015 0 0 1-4.034 2.88zM19.794 13.98h-3.908c.04-.645.06-1.31.06-1.98 0-.67-.02-1.335-.06-1.98h3.908c.096.64.146 1.3.146 1.98 0 .68-.05 1.34-.146 1.98z'/%3E%3C/svg%3E"/>
        <div class="label">Trình duyệt</div>
      </div>
      <div class="icon" data-launch="files">
        <img alt="Files" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M10 4H4c-1.1 0-2 .9-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8h-8l-4-4z'/%3E%3C/svg%3E"/>
        <div class="label">Tập tin</div>
      </div>
      <div class="icon" data-launch="imageviewer">
        <img alt="Image Viewer" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-2 0H5V5h14zm-7-3l2.03 2.71a1 1 0 0 0 1.58 0L19 13.5V17H5v-1.5l4.5-6z'/%3E%3C/svg%3E"/>
        <div class="label">Xem ảnh</div>
      </div>
      <div class="icon" data-launch="calculator">
        <img alt="Calculator" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Crect x='4' y='2' width='16' height='20' rx='3'/%3E%3Crect x='7' y='6' width='10' height='2' rx='1' fill='black'/%3E%3Ccircle cx='8.5' cy='11.5' r='1.5' fill='black'/%3E%3Ccircle cx='12' cy='11.5' r='1.5' fill='black'/%3E%3Ccircle cx='15.5' cy='11.5' r='1.5' fill='black'/%3E%3Ccircle cx='8.5' cy='15.5' r='1.5' fill='black'/%3E%3Ccircle cx='12' cy='15.5' r='1.5' fill='black'/%3E%3Ccircle cx='15.5' cy='15.5' r='1.5' fill='black'/%3E%3C/svg%3E"/>
        <div class="label">Máy tính</div>
      </div>
      <div class="icon" data-launch="bin">
        <img alt="Bin" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M3 6h18v2H3V6zm2 3h14l-1.5 12.5a2 2 0 01-2 1.5H8.5a2 2 0 01-2-1.5L5 9zm5 2v7h2v-7h-2zm4 0v7h2v-7h-2z'/%3E%3C/svg%3E"/>
        <div class="label">Thùng rác</div>
      </div>
      <div class="icon" data-launch="aichat">
        <img alt="AI Chat" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3Ccircle cx='8.5' cy='10.5' r='1.5'/%3E%3Ccircle cx='15.5' cy='10.5' r='1.5'/%3E%3Cpath d='M16 14c-1.1 1-2.5 1.5-4 1.5s-2.9-.5-4-1.5'/%3E%3C/svg%3E" style="background:#fff;border-radius:50%;padding:2px;"/>
        <div class="label">AI Chat</div>
      </div>
    </div>

    <!-- Notes Window -->
    <div class="window hidden" id="win-notes" style="left: 60px; top: 80px; width: 560px; height: 380px;" data-app="notes">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Ghi chú</div>
        <div class="spacer"></div>
      </div>
      <div class="content">
        <div class="notes-toolbar">
          <input id="notes-title" type="text" placeholder="Tiêu đề ghi chú..."/>
          <button id="notes-save">Lưu</button>
          <span id="notes-file-indicator" style="margin-left:auto; color:#9ec5ff; display:none;"></span>
          <button id="notes-save-file" style="display:none; background:#3bb06b;">Lưu vào tập tin</button>
        </div>
        <textarea id="notes-body" class="notes-textarea" placeholder="Viết ghi chú của bạn ở đây..."></textarea>
      </div>
    </div>

    <!-- Browser Window -->
    <div class="window hidden" id="win-browser" style="left: 200px; top: 140px; width: 900px; height: 600px;" data-app="browser">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Trình duyệt</div>
        <div class="spacer"></div>
      </div>
      <div class="content" style="display:flex; flex-direction:column; height:calc(100% - 38px); padding:0;">
        <div class="browser-bar" style="display:flex; gap:8px; padding:10px;">
          <button id="browser-back" title="Quay lại" style="background:#222; color:#fff; border:none; border-radius:6px; padding:0 10px; font-size:1.2em;">←</button>
          <button id="browser-forward" title="Tiến" style="background:#222; color:#fff; border:none; border-radius:6px; padding:0 10px; font-size:1.2em;">→</button>
          <input id="browser-url" type="text" placeholder="Nhập URL hoặc tìm kiếm..." style="flex:1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 10px; border-radius:6px;">
          <button id="browser-go" style="background:#2b76ff; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;">Đi</button>
          <button id="browser-refresh" title="Tải lại" style="background:#222; color:#fff; border:none; border-radius:6px; padding:0 10px; font-size:1.2em;">⟳</button>
          <button id="browser-external" title="Mở trong tab mới" style="background:#222; color:#fff; border:none; border-radius:6px; padding:0 10px; font-size:1.2em;">↗</button>
        </div>
        <iframe id="browser-frame" class="browser-frame" src="about:blank" referrerpolicy="no-referrer" sandbox="allow-scripts" style="flex:1; border:0; border-radius:0 0 10px 10px; background:#0e0e12;"></iframe>
        <div id="browser-error" style="display:none; flex:1; align-items:center; justify-content:center; color:#ffb4b4; font-size:1.2em; text-align:center; background:#18181c; border-radius:0 0 10px 10px; position:absolute; left:0; right:0; bottom:0; top:68px; z-index:10;">
          Không thể tải trang này trong trình duyệt web OS.<br>
          Nhiều trang web hiện đại chặn nhúng trong iframe.<br>
          Hãy thử một trang web khác hoặc tìm kiếm với DuckDuckGo Lite.
        </div>
      </div>
    </div>

    <!-- Image Viewer Window -->
    <div class="window hidden" id="win-imageviewer" style="left: 180px; top: 100px; width: 520px; height: 400px;" data-app="imageviewer">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Xem ảnh</div>
        <div class="spacer"></div>
      </div>
      <div class="content" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:calc(100% - 38px);">
        <input type="file" id="imgv-upload" accept="image/*" style="margin-bottom:12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 10px; border-radius:6px;">
        <img id="imgv-img" src="" alt="Chưa có ảnh" style="max-width:100%; max-height:300px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.4); display:none;">
        <div id="imgv-filename" style="margin-top:8px; color:#9ec5ff;"></div>
      </div>
    </div>

    <!-- Calculator Window -->
    <div class="window hidden" id="win-calculator" style="left: 320px; top: 160px; width: 340px; height: 480px;" data-app="calculator">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Máy tính</div>
        <div class="spacer"></div>
      </div>
      <div class="content" style="display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:calc(100% - 38px); padding:18px 10px 10px 10px;">
        <input id="calc-display" type="text" readonly style="width:100%; font-size:2.2em; text-align:right; margin-bottom:18px; background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.18); color:#fff; padding:16px 12px; border-radius:10px;">
        <div id="calc-buttons" style="width:100%; display:grid; grid-template-columns:repeat(4,1fr); gap:12px;">
          <button data-calc="C" class="calc-func">C</button>
          <button data-calc="(">(</button>
          <button data-calc=")">)</button>
          <button data-calc="/" class="calc-op">÷</button>
          <button data-calc="7">7</button>
          <button data-calc="8">8</button>
          <button data-calc="9">9</button>
          <button data-calc="*" class="calc-op">×</button>
          <button data-calc="4">4</button>
          <button data-calc="5">5</button>
          <button data-calc="6">6</button>
          <button data-calc="-" class="calc-op">−</button>
          <button data-calc="1">1</button>
          <button data-calc="2">2</button>
          <button data-calc="3">3</button>
          <button data-calc="+" class="calc-op">+</button>
          <button data-calc="0" style="grid-column:span 2;">0</button>
          <button data-calc=".">.</button>
          <button data-calc="=" style="background:#2b76ff; color:#fff; font-weight:bold;">=</button>
        </div>
      </div>
    </div>

    <!-- Bin Window -->
    <div class="window hidden" id="win-bin" style="left: 180px; top: 120px; width: 420px; height: 340px;" data-app="bin">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Thùng rác</div>
        <div class="spacer"></div>
      </div>
      <div class="content" id="bin-content" style="padding:18px;">
        <div id="bin-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:12px;"></div>
        <button id="bin-empty" style="margin-top:18px; background:#b03b3b; border:none; color:#fff; padding:8px 16px; border-radius:6px; cursor:pointer;">Dọn sạch thùng rác</button>
      </div>
    </div>

    <!-- AI Chat Window -->
    <div class="window hidden" id="win-aichat" style="left: 220px; top: 120px; width: 480px; height: 500px;" data-app="aichat">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">AI Chat</div>
        <div class="spacer"></div>
      </div>
      <div class="content" style="display:flex; flex-direction:column; height:calc(100% - 38px);">
        <div id="aichat-messages" style="flex:1; overflow:auto; background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:10px; padding:8px 4px; font-size:15px;">
          <div style="margin:8px 0; color:#9ec5ff;">
            <b>AI:</b> Xin chào! Tôi là trợ lý AI. Bạn có câu hỏi gì không?
          </div>
        </div>
        <form id="aichat-form" style="display:flex; gap:8px;">
          <input id="aichat-input" type="text" placeholder="Nhập câu hỏi..." autocomplete="off" style="flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.18); color:#fff; padding:10px; border-radius:6px;">
          <button style="background:#2b76ff; border:none; color:#fff; padding:10px 16px; border-radius:6px; cursor:pointer;">Gửi</button>
        </form>
      </div>
    </div>

    <!-- File Manager Window -->
    <div class="window hidden" id="win-files" style="left: 260px; top: 120px; width: 720px; height: 460px;" data-app="files">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Trình quản lý tập tin</div>
        <div class="spacer"></div>
      </div>
      <div class="content" id="files-content">
        <div class="fm-toolbar">
          <button id="fm-up">Lên</button>
          <button id="fm-new-folder">Thư mục mới</button>
          <button id="fm-new-file">Tập tin mới</button>
          <button id="fm-rename">Đổi tên</button>
          <button id="fm-delete">Xóa</button>
          <label style="margin-left:8px;">
            <input type="file" id="fm-upload" multiple style="display:none;">
            <button class="start-btn" id="fm-upload-btn" style="border:none;">Tải lên</button>
          </label>
          <div class="fm-breadcrumb" id="fm-breadcrumb"></div>
        </div>
        <div class="fm-list" id="fm-list"></div>
      </div>
      <!-- File Manager Context Menu -->
      <div class="context-menu" id="fm-ctx">
        <div class="ctx-item" data-action="open">Mở</div>
        <div class="ctx-item" data-action="rename">Đổi tên</div>
        <div class="ctx-item" data-action="delete">Xóa</div>
        <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 4px 2px;">
        <div class="ctx-item" data-action="new-folder">Thư mục mới</div>
        <div class="ctx-item" data-action="new-file">Tập tin mới</div>
        <div class="ctx-item" data-action="upload">Tải lên...</div>
      </div>
      <div class="resize n"></div><div class="resize s"></div><div class="resize e"></div><div class="resize w"></div>
      <div class="resize ne"></div><div class="resize nw"></div><div class="resize se"></div><div class="resize sw"></div>
    </div>

    <!-- Settings Window -->
    <div class="window hidden" id="win-settings" style="left: 140px; top: 120px; width: 520px; height: 360px;" data-app="settings">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Cài đặt</div>
        <div class="spacer"></div>
      </div>
      <div class="content">
        <div style="display:flex; flex-direction:column; gap:10px;">
          <label>Ảnh nền (URL):</label>
          <div style="display:flex; gap:8px;">
            <input id="bg-url" type="text" placeholder="https://..." style="flex:1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 10px; border-radius:6px;">
            <button id="bg-apply" style="background:#2b76ff; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;">Áp dụng</button>
          </div>
          <label>Định dạng đồng hồ:</label>
          <select id="clock-format" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color:#fff; padding:8px 10px; border-radius:6px;">
            <option value="24">24 giờ</option>
            <option value="12">12 giờ</option>
          </select>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="clear-notes" style="background:#b03b3b; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;">Xóa ghi chú</button>
            <button id="arrange" style="background:#3bb06b; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;">Sắp xếp cửa sổ</button>
          </div>

          <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 10px 0;">
          <label>Cập nhật hệ thống:</label>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <div>Phiên bản hiện tại: <strong id="ver-current">1.0.0</strong></div>
            <div>Phiên bản mới nhất: <strong id="ver-latest">1.0.0</strong></div>
          </div>
          <div id="up-msg" style="color:#ddd;"></div>
          <div style="display:flex; gap:8px;">
            <button id="up-check" style="background:#2b76ff; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;">Kiểm tra</button>
            <button id="up-install" style="background:#3bb06b; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; display:none;">Cài đặt</button>
          </div>
        </div>
      </div>
      <div class="resize n"></div><div class="resize s"></div><div class="resize e"></div><div class="resize w"></div>
      <div class="resize ne"></div><div class="resize nw"></div><div class="resize se"></div><div class="resize sw"></div>
    </div>

    <!-- Activation Window -->
    <div class="window hidden" id="win-activate" style="left: 220px; top: 140px; width: 480px; height: 260px;" data-app="activate">
      <div class="titlebar" data-drag-handle>
        <div class="traffic">
          <span class="btn btn-close" data-action="close"></span>
          <span class="btn btn-min" data-action="minimize"></span>
          <span class="btn btn-max" data-action="maximize"></span>
        </div>
        <div class="title">Kích hoạt Hyggshi OS</div>
        <div class="spacer"></div>
      </div>
      <div class="content">
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div>Nhập khóa sản phẩm (định dạng: 0000-XXXX-XXXX):</div>
          <input id="act-key" type="text" placeholder="0000-ABCD-EFGH" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); color:#fff; padding:10px; border-radius:6px;">
          <button id="act-apply" style="background:#3bb06b; border:none; color:#fff; padding:10px 12px; border-radius:6px; cursor:pointer;">Kích hoạt</button>
          <div id="act-msg" style="color:#ffb4b4;"></div>
        </div>
      </div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
      <button class="start-btn" id="start-btn">Start</button>
      <div class="apps" id="taskbar-apps"></div>
      <div class="clock" id="clock"></div>
    </div>
    
    <div class="start-menu" id="start-menu">
      <div class="start-item" data-launch="notes">Ghi chú</div>
      <div class="start-item" data-launch="browser">Trình duyệt</div>
      <div class="start-item" data-launch="files">Trình quản lý tập tin</div>
      <div class="start-item" data-launch="settings">Cài đặt</div>
      <div class="start-item" data-launch="activate">Kích hoạt Hyggshi OS</div>
      <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.12); margin: 6px 2px;">
      <div class="start-item" id="start-restart">Khởi động lại</div>
      <div class="start-item" id="start-shutdown">Tắt máy</div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="ctx">
      <div class="ctx-item" id="ctx-new-note">Mở Ghi chú</div>
      <div class="ctx-item" id="ctx-settings">Mở Cài đặt</div>
      <div class="ctx-item" id="ctx-minimize-all">Thu nhỏ tất cả</div>
    </div>
    
    <div class="watermark" id="watermark">
      <div>Activate Hyggshi OS</div>
      <div>Go to Settings to activate Hyggshi OS</div>
    </div>
    
    <div class="power-overlay" id="power-overlay">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2v10" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M6.22 6.22a7.5 7.5 0 1 0 10.61 0" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div class="msg" id="power-msg"></div>
    </div>
  </div>

  <script>
    (function() {
      const desktop = document.getElementById('desktop');
      const zStack = { current: 10 };
      const settingsKey = 'webos.settings';
      const clock = document.getElementById('clock');

      const settings = loadSettings();
      applySettings(settings);

      function bringToFront(win) {
        zStack.current += 1;
        win.style.zIndex = String(zStack.current);
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        win.classList.add('active');
      }

      function showWindow(id) {
        const win = document.getElementById(id);
        if (!win) return;
        win.classList.remove('hidden', 'minimized');
        bringToFront(win);
        updateTaskbarFor(win.dataset.app, { exists: true, active: true, minimized: false });
      }

      function hideWindow(id) {
        const win = document.getElementById(id);
        if (!win) return;
        win.classList.add('hidden');
        updateTaskbarFor(win.dataset.app, { exists: false });
      }

      function minimizeWindow(id) {
        const win = document.getElementById(id);
        if (!win) return;
        win.classList.add('minimized');
        updateTaskbarFor(win.dataset.app, { exists: true, minimized: true, active: false });
      }

      function toggleMinimize(app) {
        const win = getWindowByApp(app);
        if (!win) return;
        if (win.classList.contains('minimized')) {
          win.classList.remove('minimized');
          bringToFront(win);
          updateTaskbarFor(app, { exists: true, active: true, minimized: false });
        } else {
          win.classList.add('minimized');
          updateTaskbarFor(app, { exists: true, minimized: true, active: false });
        }
      }

      function getWindowByApp(app) {
        const windowMap = {
          'notes': 'win-notes',
          'browser': 'win-browser',
          'settings': 'win-settings',
          'files': 'win-files',
          'activate': 'win-activate',
          'imageviewer': 'win-imageviewer',
          'calculator': 'win-calculator',
          'bin': 'win-bin',
          'aichat': 'win-aichat'
        };
        return document.getElementById(windowMap[app]);
      }

      // Dragging
      function makeDraggable(win) {
        const handle = win.querySelector('.titlebar');
        let startX = 0, startY = 0, origX = 0, origY = 0;
        let dragging = false;

        handle.addEventListener('mousedown', (e) => {
          if (e.button !== 0 || e.target.closest('.btn')) return;
          
          dragging = true;
          bringToFront(win);
          startX = e.clientX;
          startY = e.clientY;
          const rect = win.getBoundingClientRect();
          origX = rect.left;
          origY = rect.top;
          document.body.style.userSelect = 'none';
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp, { once: true });
        });

        function onMove(e) {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          let nextX = origX + dx;
          let nextY = origY + dy;
          const bounds = desktop.getBoundingClientRect();
          const rect = win.getBoundingClientRect();
          const maxX = bounds.width - Math.min(rect.width, bounds.width);
          const maxY = bounds.height - 56;
          nextX = Math.max(0, Math.min(nextX, maxX));
          nextY = Math.max(0, Math.min(nextY, maxY));
          win.style.left = nextX + 'px';
          win.style.top = nextY + 'px';
        }

        function onUp() {
          dragging = false;
          document.body.style.userSelect = '';
          document.removeEventListener('mousemove', onMove);
          saveGeometry(win);
        }
      }

      function makeResizable(win) {
        const handles = ['n','s','e','w','ne','nw','se','sw'];
        handles.forEach(dir => {
          let el = win.querySelector('.resize.' + dir);
          if (!el) {
            el = document.createElement('div');
            el.className = 'resize ' + dir;
            win.appendChild(el);
          }
          
          el.addEventListener('mousedown', function onDown(e) {
            e.preventDefault();
            bringToFront(win);
            const rect = win.getBoundingClientRect();
            const startX = e.clientX, startY = e.clientY;
            const startW = rect.width, startH = rect.height, startL = rect.left, startT = rect.top;
            
            function onMove(e) {
              const dx = e.clientX - startX;
              const dy = e.clientY - startY;
              let newW = startW, newH = startH, newL = startL, newT = startT;
              
              if (dir.includes('e')) newW = Math.max(360, startW + dx);
              if (dir.includes('s')) newH = Math.max(260, startH + dy);
              if (dir.includes('w')) { newW = Math.max(360, startW - dx); newL = startL + dx; }
              if (dir.includes('n')) { newH = Math.max(260, startH - dy); newT = startT + dy; }
              
              const bounds = desktop.getBoundingClientRect();
              newL = Math.max(0, Math.min(newL, bounds.width - newW));
              newT = Math.max(0, Math.min(newT, bounds.height - 56 - newH));
              
              Object.assign(win.style, { 
                left: newL + 'px', 
                top: newT + 'px', 
                width: newW + 'px', 
                height: newH + 'px' 
              });
            }
            
            function onUp() {
              document.removeEventListener('mousemove', onMove);
              saveGeometry(win);
            }
            
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp, { once: true });
          });
        });
      }

      // Titlebar controls
      function wireWindowControls(win) {
        win.addEventListener('mousedown', () => bringToFront(win));
        
        win.querySelector('[data-action="close"]').addEventListener('click', (e) => {
          e.stopPropagation();
          hideWindow(win.id);
        });
        
        win.querySelector('[data-action="minimize"]').addEventListener('click', (e) => {
          e.stopPropagation();
          minimizeWindow(win.id);
        });
        
        win.querySelector('[data-action="maximize"]').addEventListener('click', (e) => {
          e.stopPropagation();
          toggleMaximize(win);
        });
      }

      function toggleMaximize(win) {
        const maximized = win.dataset.maximized === 'true';
        if (!maximized) {
          win.dataset.prevLeft = win.style.left;
          win.dataset.prevTop = win.style.top;
          win.dataset.prevWidth = win.style.width;
          win.dataset.prevHeight = win.style.height;
          win.style.left = '8px';
          win.style.top = '8px';
          win.style.width = 'calc(100% - 16px)';
          win.style.height = 'calc(100% - 64px)';
          win.dataset.maximized = 'true';
        } else {
          win.style.left = win.dataset.prevLeft || '60px';
          win.style.top = win.dataset.prevTop || '80px';
          win.style.width = win.dataset.prevWidth || '';
          win.style.height = win.dataset.prevHeight || '';
          win.dataset.maximized = 'false';
        }
        bringToFront(win);
        saveGeometry(win);
      }

      // Taskbar management
      const taskbar = document.getElementById('taskbar-apps');
      function updateTaskbarFor(app, state) {
        let btn = taskbar.querySelector(`[data-app="${app}"]`);
        if (!state.exists) {
          if (btn) btn.remove();
          return;
        }
        if (!btn) {
          btn = document.createElement('button');
          btn.className = 'task-btn';
          btn.dataset.app = app;
          const appNames = {
            'notes': 'Ghi chú',
            'browser': 'Trình duyệt',
            'settings': 'Cài đặt',
            'files': 'Tập tin',
            'activate': 'Kích hoạt',
            'imageviewer': 'Xem ảnh',
            'calculator': 'Máy tính',
            'bin': 'Thùng rác',
            'aichat': 'AI Chat'
          };
          btn.textContent = appNames[app] || app;
          btn.addEventListener('click', () => toggleMinimize(app));
          taskbar.appendChild(btn);
        }
        btn.classList.toggle('active', !!state.active);
      }

      // Desktop icons launcher
      document.querySelectorAll('.icon').forEach(icon => {
        icon.addEventListener('click', () => {
          const app = icon.getAttribute('data-launch');
          launchApp(app);
        });
      });

      function launchApp(app) {
        const windowMap = {
          'notes': 'win-notes',
          'browser': 'win-browser',
          'settings': 'win-settings',
          'files': 'win-files',
          'activate': 'win-activate',
          'imageviewer': 'win-imageviewer',
          'calculator': 'win-calculator',
          'bin': 'win-bin',
          'aichat': 'win-aichat'
        };
        const windowId = windowMap[app];
        if (windowId) {
          showWindow(windowId);
        }
      }

      // Wire all windows
      const allWindows = ['win-notes', 'win-browser', 'win-settings', 'win-files', 'win-activate', 'win-calculator', 'win-bin', 'win-aichat', 'win-imageviewer'];
      allWindows.forEach(winId => {
        const win = document.getElementById(winId);
        if (win) {
          makeDraggable(win);
          makeResizable(win);
          wireWindowControls(win);
          restoreGeometry(win);
        }
      });

      // AI Chat logic with Google AI Studio integration
      const aichatForm = document.getElementById('aichat-form');
      const aichatInput = document.getElementById('aichat-input');
      const aichatMessages = document.getElementById('aichat-messages');
      
      // Google AI Studio configuration
      let GEMINI_API_KEY = 'AIzaSyAt35zV-re6BdmIifXhaN7JZfOjqFL2AF8'; // Will be loaded from settings
      const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
      
      // Initialize API key from settings
      const savedSettings = loadSettings();
      if (savedSettings.apiKey) {
        GEMINI_API_KEY = savedSettings.apiKey;
      }
      window.GEMINI_API_KEY = GEMINI_API_KEY;

      function appendAIMessage(role, text) {
        const div = document.createElement('div');
        div.style.margin = '8px 0';
        div.innerHTML = `<b style="color:${role==='user'?'#9ec5ff':'#3bb06b'}">${role==='user'?'Bạn':'AI'}:</b> ${text}`;
        aichatMessages.appendChild(div);
        aichatMessages.scrollTop = aichatMessages.scrollHeight;
      }

      async function callGeminiAPI(message, apiKey) {
        try {
          const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: message
                }]
              }],
              generationConfig: {
                temperature: 0.7,
                topK: 1,
                topP: 1,
                maxOutputTokens: 2048,
              },
              safetySettings: [
                {
                  category: "HARM_CATEGORY_HARASSMENT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_HATE_SPEECH",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                }
              ]
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            if (response.status === 400 && errorData.error?.message?.includes('API_KEY_INVALID')) {
              throw new Error('API key không hợp lệ. Vui lòng kiểm tra lại trong Cài đặt.');
            }
            throw new Error(`API request failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
          }

          const data = await response.json();
          
          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            return data.candidates[0].content.parts[0].text;
          } else if (data.candidates && data.candidates[0] && data.candidates[0].finishReason === 'SAFETY') {
            return 'Xin lỗi, tôi không thể trả lời câu hỏi này do chính sách an toàn. Hãy thử hỏi một cách khác.';
          } else {
            throw new Error('Unexpected API response format');
          }
        } catch (error) {
          console.error('Gemini API Error:', error);
          if (error.message.includes('API key không hợp lệ')) {
            return error.message;
          }
          return 'Xin lỗi, đã có lỗi xảy ra khi kết nối với AI. Vui lòng kiểm tra kết nối mạng và thử lại.';
        }
      }

      if (aichatForm) {
        aichatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const msg = aichatInput.value.trim();
          if (!msg) return;
          
          appendAIMessage('user', msg);
          aichatInput.value = '';
          
          // Show typing indicator
          const typingDiv = document.createElement('div');
          typingDiv.style.margin = '8px 0';
          typingDiv.style.color = '#9ec5ff';
          typingDiv.innerHTML = '<b>AI:</b> <i>Đang gõ...</i>';
          aichatMessages.appendChild(typingDiv);
          aichatMessages.scrollTop = aichatMessages.scrollHeight;
          
          try {
            // Get current API key from settings
            const currentSettings = loadSettings();
            const currentApiKey = currentSettings.apiKey || GEMINI_API_KEY;
            
            // Check if API key is set
            if (!currentApiKey || currentApiKey === 'YOUR_GOOGLE_AI_STUDIO_API_KEY') {
              // Fallback to mock responses if API key not configured
              const responses = [
                'Xin chào! Để sử dụng AI thật, vui lòng cấu hình Google AI Studio API key trong Cài đặt.',
                'Tôi hiểu câu hỏi của bạn. Đây là phản hồi mẫu vì chưa cấu hình API.',
                'Cảm ơn bạn đã sử dụng! Hãy mở Cài đặt và thêm API key để trải nghiệm AI thực sự.',
                'Đây là phản hồi mẫu. Cấu hình Google AI Studio trong Cài đặt để có trải nghiệm tốt hơn.'
              ];
              
              setTimeout(() => {
                typingDiv.remove();
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                appendAIMessage('assistant', randomResponse);
              }, 1000 + Math.random() * 1000);
            } else {
              // Call actual Gemini API with current API key
              const aiResponse = await callGeminiAPI(msg, currentApiKey);
              typingDiv.remove();
              appendAIMessage('assistant', aiResponse);
            }
          } catch (error) {
            typingDiv.remove();
            appendAIMessage('assistant', 'Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại sau.');
            console.error('AI Chat Error:', error);
          }
        });
      }

      // Notes app logic
      const NOTES_KEY = 'webos.notes';
      const titleEl = document.getElementById('notes-title');
      const bodyEl = document.getElementById('notes-body');
      const saveBtn = document.getElementById('notes-save');
      const notesSaveFileBtn = document.getElementById('notes-save-file');
      const notesFileIndicator = document.getElementById('notes-file-indicator');
      let currentNotePath = null;

      function updateNotesBindingUI() {
        const bound = !!currentNotePath;
        if (notesFileIndicator) {
          notesFileIndicator.style.display = bound ? 'inline' : 'none';
          notesFileIndicator.textContent = bound ? `Đang chỉnh sửa: ${currentNotePath}` : '';
        }
        if (notesSaveFileBtn) notesSaveFileBtn.style.display = bound ? 'inline-block' : 'none';
      }

      function loadNotes() {
        try {
          const raw = localStorage.getItem(NOTES_KEY);
          if (!raw) return;
          const data = JSON.parse(raw);
          if (typeof data.title === 'string') titleEl.value = data.title;
          if (typeof data.body === 'string') bodyEl.value = data.body;
        } catch {}
      }

      function saveNotes() {
        const data = { title: titleEl.value || '', body: bodyEl.value || '' };
        localStorage.setItem(NOTES_KEY, JSON.stringify(data));
      }

      if (saveBtn) saveBtn.addEventListener('click', saveNotes);
      if (bodyEl) {
        bodyEl.addEventListener('input', () => {
          clearTimeout(bodyEl.__t);
          bodyEl.__t = setTimeout(saveNotes, 500);
        });
      }
      if (titleEl) {
        titleEl.addEventListener('input', () => {
          clearTimeout(titleEl.__t);
          titleEl.__t = setTimeout(saveNotes, 500);
        });
      }
      loadNotes();
      updateNotesBindingUI();

      // Browser app logic
      const goBtn = document.getElementById('browser-go');
      const urlInput = document.getElementById('browser-url');
      const frame = document.getElementById('browser-frame');
      const browserError = document.getElementById('browser-error');
      const backBtn = document.getElementById('browser-back');
      const forwardBtn = document.getElementById('browser-forward');
      const refreshBtn = document.getElementById('browser-refresh');
      const externalBtn = document.getElementById('browser-external');
      let browserHistory = [];
      let browserIndex = -1;

      function isLikelyUrl(str) {
        return /^https?:\/\//i.test(str) || /^[\w-]+\.[\w-]+/.test(str);
      }

      function normalizeUrl(u) {
        if (!u) return '';
        u = u.trim();
        if (/^https?:\/\//i.test(u)) return u;
        if (u.startsWith('www.')) return 'https://' + u;
        if (isLikelyUrl(u)) return 'https://' + u;
        return 'https://lite.duckduckgo.com/lite/?q=' + encodeURIComponent(u);
      }

      function navigate(url, addToHistory = true) {
        const navUrl = normalizeUrl(url);
        frame.src = navUrl;
        urlInput.value = url;
        if (browserError) browserError.style.display = 'none';

        frame.onload = function() {
          browserError.style.display = 'none';
          try {
            urlInput.value = frame.contentWindow.location.href;
          } catch {}
        };

        frame.onerror = function() {
          browserError.style.display = 'flex';
        };

        if (addToHistory) {
          if (browserIndex < browserHistory.length - 1) {
            browserHistory = browserHistory.slice(0, browserIndex + 1);
          }
          browserHistory.push(url);
          browserIndex = browserHistory.length - 1;
        }
        updateNavButtons();
      }

      function updateNavButtons() {
        if (backBtn) backBtn.disabled = browserIndex <= 0;
        if (forwardBtn) forwardBtn.disabled = browserIndex >= browserHistory.length - 1;
      }

      if (goBtn) goBtn.addEventListener('click', () => navigate(urlInput.value));
      if (urlInput) urlInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') navigate(urlInput.value); });
      if (backBtn) backBtn.addEventListener('click', () => { if (browserIndex > 0) navigate(browserHistory[--browserIndex], false); });
      if (forwardBtn) forwardBtn.addEventListener('click', () => { if (browserIndex < browserHistory.length - 1) navigate(browserHistory[++browserIndex], false); });
      if (refreshBtn) refreshBtn.addEventListener('click', () => { frame.src = frame.src; });
      if (externalBtn) {
        externalBtn.addEventListener('click', () => {
          let url = urlInput.value.trim();
          if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
          window.open(url, '_blank');
        });
      }

      // Image Viewer logic
      const imgvUpload = document.getElementById('imgv-upload');
      const imgvImg = document.getElementById('imgv-img');
      const imgvFilename = document.getElementById('imgv-filename');
      
      if (imgvUpload) {
        imgvUpload.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(ev) {
            imgvImg.src = ev.target.result;
            imgvImg.style.display = 'block';
            imgvFilename.textContent = file.name;
          };
          reader.readAsDataURL(file);
        });
      }

      // Calculator logic
      const calcDisplay = document.getElementById('calc-display');
      const calcButtons = document.getElementById('calc-buttons');
      let calcExpr = '';

      function updateCalcDisplay() {
        if (calcDisplay) calcDisplay.value = calcExpr || '0';
      }

      function safeEval(expr) {
        try {
          if (!/^[\d+\-*/().\s]+$/.test(expr)) return 'Err';
          const val = eval(expr);
          if (typeof val === 'number' && isFinite(val)) return val;
          return 'Err';
        } catch { return 'Err'; }
      }

      function handleCalcInput(v) {
        if (v === 'C') {
          calcExpr = '';
        } else if (v === '=') {
          calcExpr = String(safeEval(calcExpr));
        } else {
          if (calcExpr === 'Err') calcExpr = '';
          calcExpr += v;
        }
        updateCalcDisplay();
      }

      if (calcButtons) {
        calcButtons.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-calc]');
          if (!btn) return;
          handleCalcInput(btn.getAttribute('data-calc'));
        });
      }
      updateCalcDisplay();

      // Clock
      function updateClock() {
        const d = new Date();
        const two = (n) => String(n).padStart(2, '0');
        if (clock) clock.textContent = `${two(d.getHours())}:${two(d.getMinutes())}`;
      }
      updateClock();
      setInterval(updateClock, 15000);

      // Start menu
      const startBtn = document.getElementById('start-btn');
      const startMenu = document.getElementById('start-menu');
      
      if (startBtn) {
        startBtn.addEventListener('click', () => { 
          startMenu.classList.toggle('show'); 
        });
      }
      
      desktop.addEventListener('click', (e) => {
        if (!startMenu.contains(e.target) && e.target !== startBtn) {
          startMenu.classList.remove('show');
        }
      });
      
      startMenu.querySelectorAll('[data-launch]').forEach(item => {
        item.addEventListener('click', () => { 
          launchApp(item.getAttribute('data-launch')); 
          startMenu.classList.remove('show'); 
        });
      });

      const powerOverlay = document.getElementById('power-overlay');
      const powerMsg = document.getElementById('power-msg');
      const startRestart = document.getElementById('start-restart');
      const startShutdown = document.getElementById('start-shutdown');

      function showPower(msg) {
        if (powerMsg) powerMsg.textContent = msg || '';
        powerOverlay.classList.add('show');
      }

      function hidePower() { 
        powerOverlay.classList.remove('show'); 
      }

      function performRestart() {
        showPower('Đang khởi động lại...');
        setTimeout(() => { location.reload(); }, 1000);
      }

      function performShutdown() {
        showPower('Đang tắt...');
        document.querySelectorAll('.window').forEach(w => { 
          if (!w.classList.contains('hidden')) w.classList.add('minimized'); 
        });
        setTimeout(() => { hidePower(); startMenu.classList.remove('show'); }, 1200);
      }

      if (startRestart) startRestart.addEventListener('click', () => { startMenu.classList.remove('show'); performRestart(); });
      if (startShutdown) startShutdown.addEventListener('click', () => { startMenu.classList.remove('show'); performShutdown(); });

      // Activation logic
      const ACTIVATE_KEY = 'webos.activation';
      const watermarkEl = document.getElementById('watermark');
      const actInput = document.getElementById('act-key');
      const actApply = document.getElementById('act-apply');
      const actMsg = document.getElementById('act-msg');

      function isActivated() { 
        return localStorage.getItem(ACTIVATE_KEY) === '1'; 
      }
      
      function setActivated(v) { 
        if (v) localStorage.setItem(ACTIVATE_KEY,'1'); 
        else localStorage.removeItem(ACTIVATE_KEY); 
      }
      
      function updateWatermark() { 
        if (watermarkEl) watermarkEl.classList.toggle('hidden', isActivated()); 
      }

      function validKey(k) {
        const key = (k||'').trim().toUpperCase();
        if (/^0000-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(key)) return true;
        const allowed = ['HSI2-21SA-NMIC-OPOW', 'HSIO-JKSA-MZQE-UIAS'];
        return allowed.includes(key);
      }

      if (actApply) {
        actApply.addEventListener('click', () => {
          const k = actInput.value.trim().toUpperCase();
          if (!validKey(k)) {
            if (actMsg) {
              actMsg.textContent = 'Khóa không hợp lệ. Định dạng: 0000-XXXX-XXXX';
              actMsg.style.color = '#ffb4b4';
            }
            return;
          }
          setActivated(true);
          updateWatermark();
          if (actMsg) {
            actMsg.style.color = '#9dffb0';
            actMsg.textContent = 'Kích hoạt thành công!';
          }
          setTimeout(() => { hideWindow('win-activate'); }, 700);
        });
      }

      updateWatermark();

      // Context menu on desktop
      const ctx = document.getElementById('ctx');
      desktop.addEventListener('contextmenu', (e) => {
        if (e.target.closest('.window') || e.target.closest('.taskbar')) return;
        e.preventDefault();
        const bounds = desktop.getBoundingClientRect();
        const x = Math.min(e.clientX, bounds.width - 210);
        const y = Math.min(e.clientY, bounds.height - 120);
        ctx.style.left = x + 'px';
        ctx.style.top = y + 'px';
        ctx.classList.add('show');
      });

      desktop.addEventListener('click', () => ctx.classList.remove('show'));

      document.getElementById('ctx-new-note').addEventListener('click', () => { 
        launchApp('notes'); 
        ctx.classList.remove('show'); 
      });
      
      document.getElementById('ctx-settings').addEventListener('click', () => { 
        launchApp('settings'); 
        ctx.classList.remove('show'); 
      });
      
      document.getElementById('ctx-minimize-all').addEventListener('click', () => {
        document.querySelectorAll('.window').forEach(w => { 
          if (!w.classList.contains('hidden')) w.classList.add('minimized'); 
        });
        ctx.classList.remove('show');
      });

      // Settings behaviors
      const bgInput = document.getElementById('bg-url');
      const bgApply = document.getElementById('bg-apply');
      const clockFormat = document.getElementById('clock-format');
      const clearNotesBtn = document.getElementById('clear-notes');
      const arrangeBtn = document.getElementById('arrange');

      if (bgInput) bgInput.value = settings.bgUrl || '';
      if (clockFormat) clockFormat.value = settings.clock24h ? '24' : '12';

      if (bgApply) {
        bgApply.addEventListener('click', () => {
          const s = loadSettings();
          s.bgUrl = (bgInput.value || '').trim();
          saveSettings(s);
          applySettings(s);
        });
      }

      if (clockFormat) {
        clockFormat.addEventListener('change', () => {
          const s = loadSettings();
          s.clock24h = clockFormat.value === '24';
          saveSettings(s);
          applySettings(s);
        });
      }

      if (clearNotesBtn) {
        clearNotesBtn.addEventListener('click', () => {
          localStorage.removeItem('webos.notes');
          if (titleEl) titleEl.value = '';
          if (bodyEl) bodyEl.value = '';
        });
      }

      if (arrangeBtn) {
        arrangeBtn.addEventListener('click', () => {
          const windows = Array.from(document.querySelectorAll('.window')).filter(w => !w.classList.contains('hidden'));
          const bounds = desktop.getBoundingClientRect();
          let x = 12, y = 12;
          windows.forEach((w) => {
            w.classList.remove('minimized');
            w.style.left = x + 'px';
            w.style.top = y + 'px';
            bringToFront(w);
            saveGeometry(w);
            x += 32; y += 24;
            if (x > bounds.width - 360) { x = 12; }
            if (y > bounds.height - 260 - 56) { y = 12; }
          });
        });
      }

      // Settings helpers
      function loadSettings() {
        try { 
          return JSON.parse(localStorage.getItem(settingsKey)) || { clock24h: true, bgUrl: '' }; 
        } catch { 
          return { clock24h: true, bgUrl: '' }; 
        }
      }
      
      function saveSettings(s) { 
        localStorage.setItem(settingsKey, JSON.stringify(s)); 
      }
      
      function applySettings(s) {
        if (s.bgUrl) {
          desktop.style.background = `url('${s.bgUrl}') center/cover no-repeat fixed`;
        }
        updateClock();
      }

      // Geometry persistence
      function saveGeometry(win) {
        const app = win.dataset.app; 
        if (!app) return;
        const key = `webos.geometry.${app}`;
        const maximized = win.dataset.maximized === 'true';
        const rect = win.getBoundingClientRect();
        const data = { 
          left: win.style.left, 
          top: win.style.top, 
          width: win.style.width, 
          height: win.style.height, 
          maximized, 
          rect: { w: rect.width, h: rect.height } 
        };
        localStorage.setItem(key, JSON.stringify(data));
      }

      function restoreGeometry(win) {
        const app = win.dataset.app; 
        if (!app) return;
        const key = `webos.geometry.${app}`;
        try {
          const raw = localStorage.getItem(key); 
          if (!raw) return;
          const g = JSON.parse(raw);
          if (g.left) win.style.left = g.left;
          if (g.top) win.style.top = g.top;
          if (g.width) win.style.width = g.width;
          if (g.height) win.style.height = g.height;
          if (g.maximized) toggleMaximize(win);
        } catch {}
      }

      // File System Mock (simplified)
      const VFS_KEY = 'webos.vfs';
      
      function vfsLoad() {
        try { 
          return JSON.parse(localStorage.getItem(VFS_KEY)) || { name:'/', type:'dir', children:[] }; 
        } catch { 
          return { name:'/', type:'dir', children:[] }; 
        }
      }
      
      function vfsSave(tree) { 
        localStorage.setItem(VFS_KEY, JSON.stringify(tree)); 
      }

      let vfs = vfsLoad();
      let cwd = '/';
      let selected = null;

      // File Manager UI (simplified)
      const fmList = document.getElementById('fm-list');
      const fmBreadcrumb = document.getElementById('fm-breadcrumb');

      function renderFM() {
        if (fmBreadcrumb) {
          fmBreadcrumb.innerHTML = '<span data-path="/">Root</span>';
        }
        if (fmList) {
          fmList.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#9ec5ff; padding:20px;">File Manager is simplified in this version</div>';
        }
      }

      // Update center mock
      const verCurrentEl = document.getElementById('ver-current');
      const verLatestEl = document.getElementById('ver-latest');
      const upMsg = document.getElementById('up-msg');
      const upCheck = document.getElementById('up-check');
      const upInstall = document.getElementById('up-install');

      function refreshVersionUI(latest) {
        const cur = '1.0.0';
        if (verCurrentEl) verCurrentEl.textContent = cur;
        if (verLatestEl) verLatestEl.textContent = latest || cur;
        const hasUpdate = latest && latest !== cur;
        if (upInstall) upInstall.style.display = hasUpdate ? 'inline-block' : 'none';
        if (upMsg) upMsg.textContent = hasUpdate ? 'Có bản cập nhật mới sẵn sàng.' : 'Hệ thống đã cập nhật.';
      }

      let latestVersion = '1.0.0';
      refreshVersionUI(latestVersion);

      if (upCheck) {
        upCheck.addEventListener('click', () => {
          if (upMsg) upMsg.textContent = 'Đang kiểm tra...';
          setTimeout(() => { 
            latestVersion = '1.0.1'; 
            refreshVersionUI(latestVersion); 
          }, 600);
        });
      }

      if (upInstall) {
        upInstall.addEventListener('click', () => {
          if (upMsg) upMsg.textContent = 'Đang cài đặt...';
          setTimeout(() => {
            refreshVersionUI('1.0.0');
            if (upMsg) upMsg.textContent = 'Cài đặt hoàn tất. Vui lòng khởi động lại (giả lập).';
          }, 1200);
        });
      }

      // Enhanced showWindow for specific apps
      const originalShowWindow = showWindow;
      showWindow = function(id) {
        originalShowWindow(id);
        if (id === 'win-browser' && urlInput) {
          setTimeout(() => { urlInput.focus(); }, 100);
        }
        if (id === 'win-files') {
          renderFM();
        }
      };
    })();

    // Desktop Icon Free Movement
    (function() {
      const iconKey = 'webos.iconPositions';
      const icons = Array.from(document.querySelectorAll('.desktop-icons .icon'));
      const desktop = document.querySelector('.desktop');
      let iconPositions = {};
      
      try { 
        iconPositions = JSON.parse(localStorage.getItem(iconKey)) || {}; 
      } catch { 
        iconPositions = {}; 
      }

      // Restore positions
      icons.forEach(icon => {
        const id = icon.dataset.launch;
        if (iconPositions[id]) {
          icon.style.position = 'absolute';
          icon.style.left = iconPositions[id].left;
          icon.style.top = iconPositions[id].top;
        }
      });

      icons.forEach(icon => {
        icon.style.cursor = 'grab';
        let isDragging = false;
        let dragStartX = 0, dragStartY = 0, origLeft = 0, origTop = 0;

        icon.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          isDragging = false;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          origLeft = parseInt(icon.style.left || 0, 10);
          origTop = parseInt(icon.style.top || 0, 10);

          function onMouseMove(ev) {
            const dx = ev.clientX - dragStartX;
            const dy = ev.clientY - dragStartY;
            if (!isDragging && (Math.abs(dx) > 3 || Math.abs(dy) > 3)) isDragging = true;
            if (isDragging) {
              icon.style.position = 'absolute';
              const rect = desktop.getBoundingClientRect();
              let x = Math.max(0, Math.min(origLeft + dx, rect.width - icon.offsetWidth));
              let y = Math.max(0, Math.min(origTop + dy, rect.height - icon.offsetHeight - 56));
              icon.style.left = x + 'px';
              icon.style.top = y + 'px';
            }
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            if (isDragging) {
              iconPositions[icon.dataset.launch] = { left: icon.style.left, top: icon.style.top };
              localStorage.setItem(iconKey, JSON.stringify(iconPositions));
            }
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });

        icon.ondragstart = () => false;
        icon.addEventListener('dblclick', function() {
          const app = icon.getAttribute('data-launch');
          if (typeof launchApp === 'function') launchApp(app);
        });
      });
    })();
  </script>
</body>
</html>